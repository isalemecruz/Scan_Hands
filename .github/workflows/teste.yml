name: Teste PHP, Login e Banco

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-php:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar c√≥digo
        uses: actions/checkout@v4

      - name: Instalar PHP
        run: sudo apt-get install -y php-cli

      - name: Rodar script PHP
        run: php -r "echo 'GitHub Actions rodou PHP com sucesso üöÄ';"


  db-test:
    runs-on: ubuntu-latest
    steps:
      - name: Instalar MySQL client
        run: sudo apt-get install -y mysql-client

      - name: Testar logins dos alunos
        run: |
          echo "Conectando ao banco remoto e listando usu√°rios do tipo aluno..."
          mysql -h srv720.hstgr.io -P 3306 -u u357936358_librinha -p"Librinh4tcc#" u357936358_scanhands -e "
            SELECT id_usuario, email, tipo 
            FROM usuario 
            WHERE tipo = 'aluno';
          "
          
  login-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Teste de login real
        run: |
          echo "üîë Testando login no site com usu√°rio aluno..."
          RESPONSE=$(curl -s -L -c cookies.txt -b cookies.txt -X POST "https://magenta-jay-944565.hostingersite.com/login.php" \
            -d "email=aluno@gmail.com&senha=12345&tipo=aluno")

          echo "üìÑ P√°gina retornada:"
          echo "$RESPONSE" | head -n 50   # mostra s√≥ as 50 primeiras linhas do HTML

          if echo "$RESPONSE" | grep -q "inicioAluno.php"; then
            echo "‚úÖ Login realizado com sucesso e redirecionou para aluno!"
          elif echo "$RESPONSE" | grep -q "Senha ou tipo de usu√°rio incorretos"; then
            echo "‚ùå Senha ou tipo incorreto!"
            exit 1
          elif echo "$RESPONSE" | grep -q "Usu√°rio n√£o encontrado"; then
            echo "‚ùå Usu√°rio n√£o encontrado!"
            exit 1
          else
            echo "‚ö†Ô∏è Login retornou algo inesperado."
            exit 1
          fi