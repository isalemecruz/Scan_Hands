name: Teste PHP, Login e Banco

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-php:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar PHP
        run: sudo apt-get install -y php-cli

      - name: Rodar script PHP
        run: php -r "echo 'GitHub Actions rodou PHP com sucesso ðŸš€';"


  db-test:
    runs-on: ubuntu-latest
    steps:
      - name: Instalar MySQL client
        run: sudo apt-get install -y mysql-client

      - name: Testar logins dos alunos
        run: |
          echo "Conectando ao banco remoto e listando usuÃ¡rios do tipo aluno..."
          mysql -h srv720.hstgr.io -P 3306 -u u357936358_librinha -p"Librinh4tcc#" u357936358_scanhands -e "
            SELECT id_usuario, email, tipo 
            FROM usuario 
            WHERE tipo = 'aluno';
          "
          
  login-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: Instalar PHP
        run: sudo apt-get install -y php-cli php-curl

      - name: Testar logins de todos os alunos
        env:
          DB_HOST: srv720.hstgr.io
          DB_USER: u357936358_librinha
          DB_PASS: Librinh4tcc#
          DB_NAME: u357936358_scanhands
          LOGIN_URL: https://magenta-jay-944565.hostingersite.com/
        run: |
          php -r '
          $conn = new mysqli(getenv("DB_HOST"), getenv("DB_USER"), getenv("DB_PASS"), getenv("DB_NAME"));
          if ($conn->connect_error) { die("Erro no banco: " . $conn->connect_error); }

          $result = $conn->query("SELECT email, senha FROM usuario WHERE tipo=\"aluno\"");
          while ($row = $result->fetch_assoc()) {
              $email = $row["email"];
              $senha = $row["senha"];
              echo "Testando login do aluno: $email\n";

              $ch = curl_init();
              curl_setopt($ch, CURLOPT_URL, getenv("LOGIN_URL"));
              curl_setopt($ch, CURLOPT_POST, true);
              curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
                  "email" => $email,
                  "senha" => $senha,
                  "tipo" => "aluno"
              ]));
              curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
              curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true); // segue redirecionamentos
              curl_setopt($ch, CURLOPT_COOKIEJAR, "/tmp/cookies.txt"); 
              curl_setopt($ch, CURLOPT_COOKIEFILE, "/tmp/cookies.txt"); 

              $resposta = curl_exec($ch);
              $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
              curl_close($ch);

              if (strpos($resposta, "inicioAluno.php") !== false) {
                  echo "âœ… Login OK para $email\n";
              } else {
                  echo "âŒ Falha no login de $email\n";
              }
          }
          $conn->close();
          '
