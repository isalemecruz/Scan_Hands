name: Teste PHP, Login e Banco

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-php:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar código
        uses: actions/checkout@v4

      - name: Instalar PHP
        run: sudo apt-get install -y php-cli

      - name: Rodar script PHP
        run: php -r "echo 'GitHub Actions rodou PHP com sucesso 🚀';"

  db-test:
    runs-on: ubuntu-latest
    steps:
      - name: Instalar MySQL client
        run: sudo apt-get install -y mysql-client

      - name: Listar alunos no banco
        run: |
          echo "Conectando ao banco remoto e listando usuários do tipo aluno..."
          mysql -h srv720.hstgr.io -P 3306 -u u357936358_librinha -p"Librinh4tcc#" u357936358_scanhands -e "
            SELECT id_usuario, email, tipo 
            FROM usuario 
            WHERE tipo = 'aluno';
          "

  login-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Instalar PHP
        run: sudo apt-get install -y php-cli php-curl php-mbstring

      - name: Criar script de teste de login
        run: |
          cat << 'EOF' > login_test.php
          <?php
          $host = "srv720.hstgr.io";
          $db = "u357936358_scanhands";
          $user = "u357936358_librinha";
          $pass = getenv("DB_PASS");

          $conn = new mysqli($host, $user, $pass, $db);
          if ($conn->connect_error) {
              die("Erro no banco: " . $conn->connect_error);
          }

          $result = $conn->query("SELECT email, senha FROM usuario WHERE tipo='aluno'");
          if (!$result) {
              die("Erro na query: " . $conn->error);
          }

          while ($row = $result->fetch_assoc()) {
              $email = $row["email"];
              $senha = $row["senha"];
              echo "\n";
              echo "Testando login do aluno: $email\n";

              $ch = curl_init();
              curl_setopt($ch, CURLOPT_URL, "https://magenta-jay-944565.hostingersite.com/login.php");
              curl_setopt($ch, CURLOPT_POST, 1);
              curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
                  "email" => $email,
                  "senha" => $senha,
                  "tipo" => "aluno"
              ]));
              curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
              curl_setopt($ch, CURLOPT_HEADER, true);
              curl_setopt($ch, CURLOPT_FOLLOWLOCATION, false);

              $response = curl_exec($ch);
              curl_close($ch);

              if (preg_match("/Location: .*inicioAluno\\.php/i", $response)) {
                  echo "✅ Login OK para $email\n";
              } else {
                  echo "❌ Falha no login de $email\n";
              }
          }

          $conn->close();
          EOF

      - name: Rodar script de login
        env:
          DB_PASS: 'Librinh4tcc#'
        run: php login_test.php